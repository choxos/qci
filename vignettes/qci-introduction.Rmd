---
title: "Getting Started with qci"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with qci}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## What is the Quality of Care Index (QCI)?

The Quality of Care Index (QCI) is a composite metric derived from Global Burden of Disease (GBD) study data. It uses Principal Component Analysis (PCA) on four epidemiological ratios to produce a single score (0-100) for each country, year, and sex combination. Higher scores indicate better quality of care.

The four component ratios are:

- **MIR**: Mortality-to-Incidence Ratio (Deaths / Incidence)
- **YLLtoYLD**: Years of Life Lost to Years Lived with Disability ratio
- **DALtoPER**: DALY-to-Prevalence Ratio
- **PERtoINC**: Prevalence-to-Incidence Ratio

## Quick Start

```{r setup}
library(qci)
```

### Loading Sample Data

The package includes sample GBD data for demonstration:

```{r}
data(sample_gbd)
head(sample_gbd[, c("location_name", "measure_name", "metric_name", "year", "val")])
```

### Running the Pipeline

The `qci_pipeline()` function runs the entire analysis in one call:

```{r}
result <- qci_pipeline(sample_gbd, verbose = FALSE)
```

The result is a list with three elements:

```{r}
names(result)
```

### Examining Results

**Wide format** - one row per location/year/sex:

```{r}
result$wide[, .(location_name, year, sex_name, qci_score)] |>
  head(10)
```

**PCA details** - variance explained by the first principal component:

```{r}
result$pca_details
```

### Gender Disparity Ratio

Compute the GDR (Female QCI / Male QCI):

```{r}
gdr <- qci_gdr(result$wide)
head(gdr[, .(location_name, year, qci_female, qci_male, gdr, gdr_category)])
```

### Visualization

**Trend plot:**

```{r trend-plot}
plot_qci_trend(result$wide,
               locations = unique(result$wide$location_name)[1:3])
```

**Distribution plot:**

```{r dist-plot}
plot_qci_distribution(result$wide, years = c(1990, 2019))
```

## Using Your Own GBD Data

1. Export data from the [GBD Results Tool](https://vizhub.healthdata.org/gbd-results/)
2. Ensure you include all 6 measures: Deaths, Incidence, Prevalence, DALYs, YLLs, YLDs
3. Include both Rate and Number metrics
4. Load and process:

```{r eval=FALSE}
# Single file
result <- qci_pipeline("path/to/gbd_export.csv")

# Multiple files (merged automatically)
result <- qci_pipeline(c("file1.csv", "file2.csv", "file3.csv"))
```

## Step-by-Step Analysis

For more control, use individual functions:

```{r eval=FALSE}
# 1. Load
gbd <- qci_load("path/to/gbd_data.csv")

# 2. Clean and reshape
cleaned <- qci_clean(gbd)

# 3. Compute ratios
with_ratios <- qci_ratios(cleaned$wide_number)

# 4. Run PCA
pca_result <- qci_pca(with_ratios)

# 5. Gender disparity
gdr <- qci_gdr(pca_result$data)

# 6. Export
qci_export_csv(pca_result$data, "qci_results.csv")
```
